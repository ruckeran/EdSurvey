test_gads <- import_raw(tmpfile)
library(labelled)
library(eatGADS)
# Create a data frame similar to what would come from SPSS
df <- data.frame(
country = c("ALB", "ARG", "AUS", "AUT", "BEL"),
value = c(1, 1, 1, 1, 1),
stringsAsFactors = FALSE
)
# Add variable label
var_label(df$country) <- "Country code"
var_label(df$value) <- "Numeric value"
# Add value labels (these are STRING labels)
val_labels(df$country) <- c(
ALB = "Albania",
ARG = "Argentina",
AUS = "Australia",
AUT = "Austria",
BEL = "Belgium"
)
# Check labelled structure
str(df)
print(val_labels(df$country))
# ---- Try importing into eatGADS manually ----
# eatGADS expects a data frame and a valLabels data.frame
# similar to what import_raw() builds internally
# Create the corresponding value label table manually
valLabels <- data.frame(
varName = "country",
value = c("ALB", "ARG", "AUS", "AUT", "BEL"),
valLabel = c("Albania", "Argentina", "Australia", "Austria", "Belgium"),
missings = NA_character_,
stringsAsFactors = FALSE
)
# This mimics the structure that import_raw() would validate:
print(valLabels)
# If you run:
# check_valLabels(df = df, valLabels = valLabels)
# youâ€™ll see the same numeric-value error
# ---- Inspect what happens ----
try(eatGADS:::check_valLabels(df = df, valLabels = valLabels))
library(labelled)
library(eatGADS)
# Create a data frame similar to what would come from SPSS
df <- data.frame(
country = c("ALB", "ARG", "AUS", "AUT", "BEL"),
value = c(1, 1, 1, 1, 1),
stringsAsFactors = FALSE
)
# Add variable label
var_label(df$country) <- "Country code"
var_label(df$value) <- "Numeric value"
# Add value labels (these are STRING labels)
val_labels(df$country) <- c(
ALB = "Albania",
ARG = "Argentina",
AUS = "Australia",
AUT = "Austria",
BEL = "Belgium"
)
# Check labelled structure
str(df)
print(val_labels(df$country))
# Create the corresponding value label table manually
valLabels <- data.frame(
varName = "country",
value = c("ALB", "ARG", "AUS", "AUT", "BEL"),
valLabel = c("Albania", "Argentina", "Australia", "Austria", "Belgium"),
missings = NA_character_,
stringsAsFactors = FALSE
)
# This mimics the structure that import_raw() would validate:
print(valLabels)
# ---- Inspect what happens ----
try(eatGADS:::check_valLabels(df = df, valLabels = valLabels))
gads <- import_raw(df = df, varLabels = varLabels, valLabels = valLabels,
checkVarNames = FALSE)
# Create the corresponding value label table manually
dat <- data.frame(
varName = "country",
value = c("ALB", "ARG", "AUS", "AUT", "BEL"),
valLabel = c("Albania", "Argentina", "Australia", "Austria", "Belgium"),
missings = NA_character_,
stringsAsFactors = FALSE
)
gads <- import_raw(df = dat, varLabels = varLabels, valLabels = valLabels,
checkVarNames = FALSE)
df <- data.frame(
country = c("ALB", "ARG", "AUS", "AUT", "BEL"),
value = c(1, 1, 1, 1, 1),
stringsAsFactors = FALSE
)
val_labels(df$country) <- c(
ALB = "Albania",
ARG = "Argentina",
AUS = "Australia",
AUT = "Austria",
BEL = "Belgium"
)
View(df)
valLabels <- data.frame(
varName = "country",
value = c("ALB", "ARG", "AUS", "AUT", "BEL"),
valLabel = c("Albania", "Argentina", "Australia", "Austria", "Belgium"),
missings = NA_character_,
stringsAsFactors = FALSE
)
gads <- import_raw(df = dat, varLabels = varLabels, valLabels = valLabels,
checkVarNames = FALSE)
gads <- import_raw(df = dat, valLabels = valLabels,
checkVarNames = FALSE)
varLabels <- data.frame(varName = "country",
varLabel = "Land",
stringsAsFactors = FALSE)
valLabels <- data.frame(
varName = "country",
value = c("ALB", "ARG", "AUS", "AUT", "BEL"),
valLabel = c("Albania", "Argentina", "Australia", "Austria", "Belgium"),
missings = NA_character_,
stringsAsFactors = FALSE
)
gads <- import_raw(df = dat, varLabels = varLabels, valLabels = valLabels,
checkVarNames = FALSE)
View(df)
varLabels <- data.frame(varName = c("country", "value"),
varLabel = c("Land", "test"),
stringsAsFactors = FALSE)
valLabels <- data.frame(
varName = "country",
value = c("ALB", "ARG", "AUS", "AUT", "BEL"),
valLabel = c("Albania", "Argentina", "Australia", "Austria", "Belgium"),
missings = NA_character_,
stringsAsFactors = FALSE
)
gads <- import_raw(df = dat, varLabels = varLabels, valLabels = valLabels,
checkVarNames = FALSE)
gads <- import_raw(df = df, varLabels = varLabels, valLabels = valLabels,
checkVarNames = FALSE)
varLabels <- data.frame(varName = "country",
varLabel = "Land",
stringsAsFactors = FALSE)
valLabels <- data.frame(
varName = "country",
value = c("ALB", "ARG", "AUS", "AUT", "BEL"),
valLabel = c("Albania", "Argentina", "Australia", "Austria", "Belgium"),
missings = NA_character_,
stringsAsFactors = FALSE
)
gads <- import_raw(df = df, varLabels = varLabels, valLabels = valLabels,
checkVarNames = FALSE)
library(tidyr)
library(dplyr)
library(eatGADS)
str(dat$variableName)
str(dat$Labels)
n <- length(dat$variableName)
varLabels <- data.frame(varName = dat$variableName,
varLabel = dat$Labels,
format = rep(NA, n),
display_width = rep(NA, n),
labeled = rep(NA, n),
value = rep(NA, n),
valLabel = rep(NA, n),
missings = rep(NA, n),
stringsAsFactors = FALSE)
View(varLabels)
n <- length(dat$variableName)
varLabels <- data.frame(varName = dat$variableName,
varLabel = dat$Labels,
format = rep(NA, n),
display_width = rep(NA, n),
labeled = rep(NA, n),
value = rep(NA, n),
valLabel = rep(NA, n),
missings = rep(NA, n),
stringsAsFactors = FALSE)
valLabels <- data.frame(varName = dat_long2$varName,
value = dat_long2$value,
valLabel = dat_long2$valLabel,
missings = dat_long2$missings,
stringsAsFactors = FALSE)
df_merged <- merge(varLabels, valLabels, by = "varName", all.x = TRUE, sort = FALSE)
View(df_merged)
df_merged <- merge(varLabels, valLabels, by = "varName", all.x = FALSE, sort = FALSE)
View(df_merged)
dat$Labels == dat_long2$valLabel
table(dat_long2$valLabel)
n <- length(dat$variableName)
varLabels <- data.frame(varName = dat$variableName,
varLabel = dat$Labels,
format = rep(NA, n),
display_width = rep(NA, n),
labeled = rep(NA, n),
stringsAsFactors = FALSE)
valLabels <- data.frame(varName = dat_long2$varName,
value = dat_long2$value,
valLabel = dat_long2$valLabel,
missings = dat_long2$missings,
stringsAsFactors = FALSE)
df_merged <- merge(varLabels, valLabels, by = "varName", all.x = FALSE, sort = FALSE)
View(df_merged)
vars <- pisa_list2$`2000`$dataList$Student$fileFormat$variableName
df <- as.data.frame(lapply(vars, function(x) character(0)))
names(df) <- vars
eatGADS:::new_GADSdat(df, df_merged)
gads <- eatGADS:::new_GADSdat(df, df_merged)
View(gads)
n <- length(dat$variableName)
varLabels <- data.frame(varName = dat$variableName,
varLabel = dat$Labels,
format = rep(NA, n),
display_width = rep(NA, n),
labeled = rep(NA, n),
stringsAsFactors = FALSE)
valLabels <- data.frame(varName = dat_long2$varName,
value = dat_long2$value,
valLabel = dat_long2$valLabel,
missings = dat_long2$missings,
stringsAsFactors = FALSE)
labels <- merge(varLabels, valLabels, by = "varName", all.x = FALSE, sort = FALSE)
vars <- pisa_list2$`2000`$dataList$Student$fileFormat$variableName
df <- as.data.frame(lapply(vars, function(x) character(0)))
names(df) <- vars
gads <- eatGADS:::new_GADSdat(df, labels)
View(gads)
dat <- pisa_list2$`2000`$dataList$Student$fileFormat
max_parts <- max(sapply(strsplit(dat$labelValues, "\\^"), length), na.rm = TRUE) # Determine the number of parts per line
into <- paste0("val", seq_len(max_parts)) # Generate and separate column names
dat_wide <- tidyr::separate(dat, labelValues, into = into, sep = "\\^", fill = "right") %>%
select(!(Start:multiplier) & !(labelled) & !(Type:Width2))
dat_long <- dat_wide |>
pivot_longer(cols = starts_with("val"),
names_to = "valnum",
values_to = "pair",
values_drop_na = TRUE) |>
separate(pair, into = c("code", "label"),
sep = "=", fill = "right")
# GADSdats expect specific variable names
dat_long <- dat_long %>%
rename(varName = variableName,
varLabel = Labels,
value   = code,
valLabel = label)
# Creating new missing tags
setMissingtags <- function(val, miss_str) {
val_chr <- as.character(val)
if (is.na(val)) return(NA_character_) # if the value itself is missing -> NA
miss_vals <- unlist(strsplit(as.character(miss_str), ";")) # split semicolon-separated codes
if (val_chr %in% miss_vals || val_chr %in% c("n", "r")) "miss" else "valid"
}
dat_long$missings <- mapply(setMissingtags, dat_long$value, dat_long$missing, USE.NAMES = FALSE)
n <- length(dat$variableName)
varLabels <- data.frame(varName = dat$variableName,
varLabel = dat$Labels,
format = rep(NA, n),
display_width = rep(NA, n),
labeled = rep(NA, n),
stringsAsFactors = FALSE)
valLabels <- data.frame(varName = dat_long2$varName,
value = dat_long2$value,
valLabel = dat_long2$valLabel,
missings = dat_long2$missings,
stringsAsFactors = FALSE)
labels <- merge(varLabels, valLabels, by = "varName", all.x = FALSE, sort = FALSE)
vars <- pisa_list2$`2000`$dataList$Student$fileFormat$variableName
df <- as.data.frame(lapply(vars, function(x) character(0)))
n <- length(dat$variableName)
varLabels <- data.frame(varName = dat$variableName,
varLabel = dat$Labels,
format = rep(NA, n),
display_width = rep(NA, n),
labeled = rep(NA, n),
stringsAsFactors = FALSE)
valLabels <- data.frame(varName = dat_long$varName,
value = dat_long$value,
valLabel = dat_long$valLabel,
missings = dat_long$missings,
stringsAsFactors = FALSE)
labels <- merge(varLabels, valLabels, by = "varName", all.x = FALSE, sort = FALSE)
vars <- pisa_list2$`2000`$dataList$Student$fileFormat$variableName
df <- as.data.frame(lapply(vars, function(x) character(0)))
names(df) <- vars
gads <- eatGADS:::new_GADSdat(df, labels)
# --------------------------------------------------------------------------------------------------
# -------- Syntax for downloading and reading in OECD PISA data directly from their website --------
# --------------------------------------------------------------------------------------------------
# Packages needed ----------------------------------------------------------------------------------
library(readr)
# library(eatGADS)
library(devtools)
devtools::load_all()
library(readr)
# library(eatGADS)
library(devtools)
devtools::load_all()
install.packages("Dire")
library(readr)
# library(eatGADS)
library(devtools)
devtools::load_all()
devtools::load_all()
downloadPISA(root = "C:/Users/ruckeran/Downloads", years = c(2000, 2003, 2006, 2009, 2012), database = "INT")
# library(eatGADS)
library(EdSurvey)
downloadPISA(root = "C:/Users/ruckeran/Downloads", years = c(2000, 2003, 2006, 2009, 2012), database = "INT")
years <- c("2000","2003","2006","2009","2012")
base  <- "C:/Users/ruckeran/Downloads/PISA"
# reading individually, using forceReread to ensure that everything is freshly read in
pisa_list2 <- setNames(lapply(years, function(yr) {
cat("\n--- Reading PISA", yr, "---\n")
readPISA(path = file.path(base, yr),
countries = "deu",
cognitive = "score",
forceReread = TRUE)
}), years)
pisa_list <- pisa_list2
# --------------------------------------------------------------------------------------------------
# -------------------------- Converting EdSurvey.DataFrame into GADSdat ----------------------------
# --------------------------------------------------------------------------------------------------
# Packages needed ----------------------------------------------------------------------------------
library(tidyr)
library(dplyr)
library(eatGADS)
# Splitting labelValues at "^" ---------------------------------------------------------------------
dat <- pisa_list2$`2000`$dataList$Student$fileFormat
max_parts <- max(sapply(strsplit(dat$labelValues, "\\^"), length), na.rm = TRUE) # Determine the number of parts per line
into <- paste0("val", seq_len(max_parts)) # Generate and separate column names
dat_wide <- tidyr::separate(dat, labelValues, into = into, sep = "\\^", fill = "right") %>%
select(!(Start:multiplier) & !(labelled) & !(Type:Width2))
# Converting dat into long format (and splitting values and value labels) --------------------------
dat_long <- dat_wide |>
pivot_longer(cols = starts_with("val"),
names_to = "valnum",
values_to = "pair",
values_drop_na = TRUE) |>
separate(pair, into = c("code", "label"),
sep = "=", fill = "right")
# GADSdats expect specific variable names
dat_long <- dat_long %>%
rename(varName = variableName,
varLabel = Labels,
value   = code,
valLabel = label)
# Creating new missing tags
setMissingtags <- function(val, miss_str) {
val_chr <- as.character(val)
if (is.na(val)) return(NA_character_) # if the value itself is missing -> NA
miss_vals <- unlist(strsplit(as.character(miss_str), ";")) # split semicolon-separated codes
if (val_chr %in% miss_vals || val_chr %in% c("n", "r")) "miss" else "valid"
}
dat_long$missings <- mapply(setMissingtags, dat_long$value, dat_long$missing, USE.NAMES = FALSE)
# Preparing meta data and data for GADSdat ---------------------------------------------------------
n <- length(dat$variableName)
varLabels <- data.frame(varName = dat$variableName,
varLabel = dat$Labels,
format = rep(NA, n),
display_width = rep(NA, n),
labeled = rep(NA, n),
stringsAsFactors = FALSE)
valLabels <- data.frame(varName = dat_long$varName,
value = dat_long$value,
valLabel = dat_long$valLabel,
missings = dat_long$missings,
stringsAsFactors = FALSE)
labels <- merge(varLabels, valLabels, by = "varName", all.x = FALSE, sort = FALSE)
vars <- pisa_list2$`2000`$dataList$Student$fileFormat$variableName
df <- as.data.frame(lapply(vars, function(x) character(0)))
names(df) <- vars
gads <- eatGADS:::new_GADSdat(df, labels)
View(gads)
View(gads)
dat <- pisa_list2$`2000`$dataList$Student$fileFormat
#max_parts <- max(sapply(strsplit(dat$labelValues, "\\^"), length), na.rm = TRUE) # Determine the number of parts per line
max_parts <- max(str_count(dat$labelValues, "\\^"), na.rm = TRUE) + 1
library(stringr)
dat <- pisa_list2$`2000`$dataList$Student$fileFormat
#max_parts <- max(sapply(strsplit(dat$labelValues, "\\^"), length), na.rm = TRUE) # Determine the number of parts per line
max_parts <- max(str_count(dat$labelValues, "\\^"), na.rm = TRUE) + 1
into <- paste0("val", seq_len(max_parts)) # Generate and separate column names
dat_wide <- tidyr::separate(dat, labelValues, into = into, sep = "\\^", fill = "right") %>%
select(!(Start:multiplier) & !(labelled) & !(Type:Width2))
dat_long <- dat_wide |>
pivot_longer(cols = starts_with("val"),
names_to = "valnum",
values_to = "pair",
values_drop_na = TRUE) |>
separate(pair, into = c("code", "label"),
sep = "=", fill = "right")
# GADSdats expect specific variable names
dat_long <- dat_long %>%
rename(varName = variableName,
varLabel = Labels,
value   = code,
valLabel = label)
# Creating new missing tags
setMissingtags <- function(val, miss_str) {
val_chr <- as.character(val)
if (is.na(val)) return(NA_character_) # if the value itself is missing -> NA
miss_vals <- unlist(strsplit(as.character(miss_str), ";")) # split semicolon-separated codes
if (val_chr %in% miss_vals || val_chr %in% c("n", "r")) "miss" else "valid"
}
dat_long$missings <- mapply(setMissingtags, dat_long$value, dat_long$missing, USE.NAMES = FALSE)
n <- length(dat$variableName)
varLabels <- data.frame(varName = dat$variableName,
varLabel = dat$Labels,
format = rep(NA, n),
display_width = rep(NA, n),
labeled = rep(NA, n),
stringsAsFactors = FALSE)
valLabels <- data.frame(varName = dat_long$varName,
value = dat_long$value,
valLabel = dat_long$valLabel,
missings = dat_long$missings,
stringsAsFactors = FALSE)
labels <- merge(varLabels, valLabels, by = "varName", all.x = FALSE, sort = FALSE)
vars <- pisa_list2$`2000`$dataList$Student$fileFormat$variableName
df <- as.data.frame(lapply(vars, function(x) character(0)))
names(df) <- vars
gads <- eatGADS:::new_GADSdat(df, labels)
View(dat_wide)
library(readr)
library(EdSurvey)
library(tidyr)
library(dplyr)
library(eatGADS)
library(stringr)
install.packages("stringr")
library(stringr)
library(readr)
library(EdSurvey)
downloadPISA(root = "C:/Users/ruckeran/Downloads", years = c(2000, 2003, 2006, 2009, 2012), database = "INT")
years <- c("2000","2003","2006","2009","2012")
base  <- "C:/Users/ruckeran/Downloads/PISA"
# reading individually, using forceReread to ensure that everything is freshly read in
pisa_list2 <- setNames(lapply(years, function(yr) {
cat("\n--- Reading PISA", yr, "---\n")
readPISA(path = file.path(base, yr),
countries = "deu",
cognitive = "score",
forceReread = TRUE)
}), years)
library(remotes)
library(eatFDZ)
pisa2000 <- eatGADS::import_spss("https://fdz.iqb.hu-berlin.de/media/study_files/61/PISA2000_15J_SC.sav", checkVarNames = FALSE)
test <- compare_data(gads, pisa2000, name_data1 = "OECD", name_data2 = "FDZ")
# --------------------------------------------------------------------------------------------------
# -------------------------- Converting EdSurvey.DataFrame into GADSdat ----------------------------
# --------------------------------------------------------------------------------------------------
# Packages needed ----------------------------------------------------------------------------------
library(tidyr)
library(dplyr)
library(eatGADS)
library(stringr)
# Splitting labelValues at "^" ---------------------------------------------------------------------
dat <- pisa_list2$`2000`$dataList$Student$fileFormat
max_parts <- max(str_count(dat$labelValues, "\\^"), na.rm = TRUE) + 1 # Determine the number of parts per line
into <- paste0("val", seq_len(max_parts)) # Generate and separate column names
dat_wide <- tidyr::separate(dat, labelValues, into = into, sep = "\\^", fill = "right") %>%
select(!(Start:multiplier) & !(labelled) & !(Type:Width2))
# Converting dat into long format (and splitting values and value labels) --------------------------
dat_long <- dat_wide |>
pivot_longer(cols = starts_with("val"),
names_to = "valnum",
values_to = "pair",
values_drop_na = TRUE) |>
separate(pair, into = c("code", "label"),
sep = "=", fill = "right")
# GADSdats expect specific variable names
dat_long <- dat_long %>%
rename(varName = variableName,
varLabel = Labels,
value   = code,
valLabel = label)
# Creating new missing tags
setMissingtags <- function(val, miss_str) {
val_chr <- as.character(val)
if (is.na(val)) return(NA_character_) # if the value itself is missing -> NA
miss_vals <- unlist(strsplit(as.character(miss_str), ";")) # split semicolon-separated codes
if (val_chr %in% miss_vals || val_chr %in% c("n", "r")) "miss" else "valid"
}
dat_long$missings <- mapply(setMissingtags, dat_long$value, dat_long$missing, USE.NAMES = FALSE)
# Preparing meta data and data for GADSdat ---------------------------------------------------------
n <- length(dat$variableName)
varLabels <- data.frame(varName = dat$variableName,
varLabel = dat$Labels,
format = rep(NA, n),
display_width = rep(NA, n),
labeled = rep(NA, n),
stringsAsFactors = FALSE)
valLabels <- data.frame(varName = dat_long$varName,
value = dat_long$value,
valLabel = dat_long$valLabel,
missings = dat_long$missings,
stringsAsFactors = FALSE)
labels <- merge(varLabels, valLabels, by = "varName", all.x = FALSE, sort = FALSE)
vars <- pisa_list2$`2000`$dataList$Student$fileFormat$variableName
df <- as.data.frame(lapply(vars, function(x) character(0)))
names(df) <- vars
gads <- eatGADS:::new_GADSdat(df, labels)
library(eatFDZ)
pisa2000 <- eatGADS::import_spss("https://fdz.iqb.hu-berlin.de/media/study_files/61/PISA2000_15J_SC.sav", checkVarNames = FALSE)
test <- compare_data(gads, pisa2000, name_data1 = "OECD", name_data2 = "FDZ")
remotes::install_github("beckerbenj/eatDataTest")
gads2 <- gads
gads2$labels$value <- as.numeric(gads2$labels$value)
test <- compare_data(gads2, pisa2000, name_data1 = "OECD", name_data2 = "FDZ")
str(test)
eatAnalysis::write_xlsx(test, "C:/Users/ruckeran/Downloads/PISA.xlsx")
?eatFDZ::compare_data
test <- compare_data(gads2, pisa2000, name_data1 = "OECD", name_data2 = "FDZ",
metaExceptions = c("display_width", "labeled", "format"))
eatAnalysis::write_xlsx(test, "C:/Users/ruckeran/Downloads/PISA.xlsx")
